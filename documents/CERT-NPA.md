Процедура сертифікації розширення НПА протоколу СЕВ
===================================================

## Зміст

Протокол сертифікації передбачає п'ять окремих сценарія перевірки.

1. Трьохетапне погодження
2. Перевірка відхилення
3. Перевірка подовження
4. Перевірка передачі НПА батьківській організації
5. Генерація аркушу погодження

## 1. Трьохетапне НПА погодження

Створення першого етапу та відправка ініціативного листа НПА погодження на Мінтест `77777777`:

```
> stage = "1"
> {urn,act} = {"202107.00255-У", "F0E43E21-3995-4363-95F1-75710444F628"}
> request = "6EEEBEB1-300E-495E-9B10-93CC8803DC35"
> from = "34239034"
> to = "77777777"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "2A08B638-E344-4C02-B88D-627D041B50E1"
> SEV.REPLY.acks3 from, to, {approve}
```

Дочекайтеся отримання квитанцій:

```
> SEV.download_all "34239034"
```

Закриття першого етапу:

```
> NPA.close "F0E43E21-3995-4363-95F1-75710444F628", 1
```

Створення другого етапу та відправка ініціативного листа НПА погодження на Мінюст `00015622`:

```
> stage = "2"
> from = "34239034"
> to = "00015622"
> request = "EB9B056C-8941-4F13-8B21-B309CCC75FF2"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "57F8B47D-BF09-4F60-9E6E-7B09969E83BF"
> SEV.REPLY.acks3 from, to, {approve}
```

Дочекайтеся отримання квитанцій:

```
> SEV.download_all "34239034"
```

Закриття другого етапу:

```
> NPA.close "F0E43E21-3995-4363-95F1-75710444F628", 2
```

Створення третього етапу та відправка ініціативного листа НПА погодження на Кабмін `00000003`:

```
> stage = "3"
> from = "34239034"
> to = "00000003"
> request = "E872758E-1DAD-441E-B0F3-CE3A66A4E562"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "2FE5F6EA-D94F-4D16-9F65-171843E03D0F"
> SEV.REPLY.acks3 from, to, {approve}
```

Дочекайтеся отримання квитанцій:

```
> SEV.download_all "34239034"
```

Закриття третього етапу:

```
> NPA.close "F0E43E21-3995-4363-95F1-75710444F628", 3
```

## 2. Перевірка відхилення НПА

Створення першого етапу

```
> stage = "1"
> {urn,act} = {"202107.00256-У", "DED101D4-B235-49B2-A2A3-05AB3D3B1CCB"}
> request = "9D468DA5-4895-4312-B6A3-D45E12A8E32A"
> from = "34239034"
> to = "77777777"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "EF8FDC7B-719F-430F-87E0-09B16CC1FE56"
> SEV.REPLY.acks3 from, to, {approve}
```

У документі відповіді оператор надсилає відхилення погодження НПА, що означає
що функця закриття етапу CLOSE не повинна бути доступна на СЕД клієнті після цього.

Робимо відхилення НПА:

```
> NPA.revoke "DED101D4-B235-49B2-A2A3-05AB3D3B1CCB", 1
```

## 3. Перевірка функції продовження НПА проекту

Створення першого етапу

```
> stage = "1"
> {urn,act} = {"202107.00257-У", "5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D"}
> request = "5C7CAFA3-A226-476D-AD39-5E2D6F3680B4"
> from = "34239034"
> to = "77777777"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "BD8ABE1A-9546-46FA-9E99-5493A81C979E"
> SEV.REPLY.acks3 from, to, {approve}
```

Закриття першого етапу:

```
> NPA.close "5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D", 1
```

Створення другого етапу:

```
> stage = "2"
> {urn,act} = {"202107.00257-У", "5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D"}
> request = "4A66F2D6-F0CF-403A-9388-7E9784143755"
> from = "34239034"
> to = "00015622"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Продовження другого етапу:

```
> NPA.extend "5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D", 2
```

## 4. Перевірка передачі НПА батьківській організації

Для перевірки передачі НПА батьківській організації на площадці СЕВ повинні бути спаровані
дві організації (підлегла та батьківська). Після цього відкривається можливість створювати 0-й етап погодження.
В процесі роботи на третьому етапі дозволяється робити трансфер (передача цього НПА проекту) в батьківську організацію.

```
> stage = "0"
> {urn,act} = SEV.CERT.legalAct0
> {urn,act} = {"202107.00259-У", "F3D51A76-3E19-4A23-9787-AF9781627E63"}
> request = "AD16BF24-A075-4551-ABC9-6827E681C09A"
> from = "34239034"
> to =  "77777777"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

```
> approve = "93BD8187-CF11-42D4-9773-AECA46C47198"
> SEV.REPLY.acks3 from, to, {approve}
```

Закриття 0-го етапу:

```
> NPA.close "F3D51A76-3E19-4A23-9787-AF9781627E63", 0
```

Протокол НПА з нульовим етапом передбачає, що на 3-му етапі,
даний НПА передається на батьківську організацію, і далі вже вона погоджує з КМУ,
таким чином шоб підлегла могла тільки бачити хід погодження 3-го етапу.

Погодження першого етапу на Мінфін `00013480`:

```
> stage = "1"
> {urn,act} = {"202107.00260-У", "E408DCA4-68A2-4C6B-A351-8675E795A040"}
> request = "1AA90A51-4E67-4CF3-AD07-985B5BA5056A"
> from = "34239034"
> to =  "00013480"
> SEV.send(from, to, ERP.sevDoc(SEV.LEGAL.testLegalRequest(request, urn, act, stage), legal: 1))
```

Дочекайтеся отримання 3 квитанцій (доставка, завантаження на стороні контрагента, квитанція про реєстрацію):

```
> SEV.download_all "34239034"
```

Після завантаження в логах знаходимо та перевпевнюємося що зі сторони контрагента
надісланий документ (інформаційне повідомлення) разом з трьома квитанціями.
Номер інформаційного повідомлення зберігаємо в змінну `approve`:

```
> approve = "02A7A655-9496-4E47-BD24-D734D34B13D4"
> SEV.REPLY.acks3 from, to, {approve}
```

Пропуск першого етапу:

```
> NPA.skip "F3D51A76-3E19-4A23-9787-AF9781627E63", 1
```

Після команди SKIP проект НПА одразу переводиться на третю стадію, у якій ми відсилаємо
звичайний ІП інформаційного листа, а не ІП листа НПА погодження.

```
> stage = "3"
> {urn,act} = {"202107.00260-У", "E408DCA4-68A2-4C6B-A351-8675E795A040"}
> request = "37EA3729-E14B-4F11-A701-14FA9D89E2E3"
> from = "34239034"
> to = "77777777"
```

```
> SEV.send(from, to, SEV.LEGAL.testLegalInformationTransfer(request, urn, act, stage)
```

## 5. Генерація аркушів погодження

```
> CRON.start
> CRON.generateReportNPA "5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D"
> CRON.generateReportNPA "06BBF201-6809-469E-AB05-4927625B4631"
> CRON.generateReportNPA "F0E43E21-3995-4363-95F1-75710444F628"
> CRON.generateReportNPA "F3D51A76-3E19-4A23-9787-AF9781627E63"
> CRON.generateReportNPA "DED101D4-B235-49B2-A2A3-05AB3D3B1CCB"
```

```
$ ls -1 priv/sev/npa-reports/*.docx
priv/sev/npa-reports/06BBF201-6809-469E-AB05-4927625B4631.docx
priv/sev/npa-reports/5ABBFDCC-A61A-4C0C-BB5C-013A886D9F9D.docx
priv/sev/npa-reports/DED101D4-B235-49B2-A2A3-05AB3D3B1CCB.docx
priv/sev/npa-reports/F0E43E21-3995-4363-95F1-75710444F628.docx
priv/sev/npa-reports/F3D51A76-3E19-4A23-9787-AF9781627E63.docx
```

ДП "ІНФОТЕХ"<br>
Максим Сохацький
